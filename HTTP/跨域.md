## CORS（跨域资源共享） ##

### 为什么会发生跨域？
- 浏览器限制
- 跨域（协议、域名、端口，任意一个不同，就会发生跨域）
- XHR（XMLHttpRequest）请求。  
    json、script 请求不会发生跨域问题。
```
// 这种标签是不会遇到"跨域"问题的
<script type="text/javascript" src="http://www.a.com/scripts/1.js"></script>
<img src="http://www.b.com/images/1.jpg" />
<link rel="stylesheet" href="http://www.c.com/assets/css/1.css" />
```

### 如何解决跨域问题？
| 针对的问题 | 解决方案 | 备注  |
| --------- | ------- | --------- |
| 针对浏览器限制 | 禁止浏览器跨域检查 | [--disable-web-security](https://www.cnblogs.com/zhongxia/p/5416024.html)  |
| 针对XHR 请求 | 使用 JSONP | JSONP 不是 XHR 请求 |
| 针对跨域 | 1）被调用方允许跨域。2）调用方隐藏跨域 | 

### JSONP
JSONP实现跨域请求的原理：  
【原理】：Ajax 的跨域受到“同源策略”的限制，但是像 ```<script>``` 及 ```<img>``` 标签带有 src 属性，都可不受限制地其他域中加载资源，JSONP 则是通过动态 ```<script>``` 元素来使用的。  
【实现方式】：jsonp跨域请求的关键就在于：服务端要在返回的数据外层包裹一个客户端已经定义好的函数。如：
```
callback( {"result":"success"} )
```

使用 jQuery 发送 JSONP 请求：
```
$.ajax({
    url: '...',
    dataType: 'jsonp',  // 预期服务器返回的数据类型
    jsonp: 'callback',  // 默认是 callback，JSONP回调参数的名称，即前后端约定的字段名
    cache: true,    // 是否启用缓存
    success: function(){
        // ....
    }
})
```

JSONP有什么弊端？
- 服务器需要改动代码支持。  
    服务端不能返回 JSON 对象。因为我们请求的数据会立马被浏览器当作javascript语句去执行（谁让我们用 script 去请求数据呢）
    ![JSONP](../images/跨域_JSONP.jpg)
    在支持Spring MVC的项目中，可以在服务端添加一个JSONP的切面去处理JSONP响应。
- 只支持GET。即使把请求类型设置为post，其本质上仍然是一个get请求。
- 发送的不是 XHR 请求。JSONP不是一种标准协议，其安全性和稳定性不太好。

### 被调用方（服务端）允许跨域
[Spring MVC 从4.2版本开始增加了对CORS的支持](https://my.oschina.net/wangnian/blog/689020)


### 调用方隐藏跨域


参考文档：
1. [CORS预检请求详谈](http://www.cnblogs.com/wonyun/p/CORS_preflight.html)
2. [跨域资源共享 CORS 详解](http://www.ruanyifeng.com/blog/2016/04/cors.html)
3. [SpringMvc解决跨域问题](https://my.oschina.net/wangnian/blog/689020)